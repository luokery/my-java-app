<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- 从 Spring Boot 的 application.yml 中获取应用名称 -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="demo"/>
    
    <!-- 定义日志文件的存储路径 -->
    <property name="LOG_PATH" value="./logs"/>

    <!-- 1. 定义统一的日志格式为变量 -->
    <property name="DEF_LOG_FORMAT" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"/>

    <!-- ================================================================== -->
    <!--                            Appenders                               -->
    <!-- ================================================================== -->

    <!-- A. 控制台 Appender -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${DEF_LOG_FORMAT}</pattern>
        </encoder>
    </appender>

    <!-- B. 临时测试文件 Appender (每次启动时清空) -->
    <appender name="TEMP_FILE" class="ch.qos.logback.core.FileAppender">
        <!-- append=false 表示每次启动都重写文件 -->
        <append>false</append>
        <file>${LOG_PATH}/temp-test.log</file>
        <encoder>
            <pattern>${DEF_LOG_FORMAT}</pattern>
        </encoder>
    </appender>

    <!-- C. 滚动归档文件 Appender (记录 WARN 及以上级别) -->
    <appender name="ROLLING_FILE_ARCHIVE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- 只记录 WARN 和 ERROR 级别的日志 -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>WARN</level>
        </filter>
        
        <!-- 当前正在写入的日志文件 -->
        <file>${LOG_PATH}/${APP_NAME}.log</file>

        <!-- 定义滚动和归档策略：基于时间和大小 -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 归档文件的命名模式 -->
            <!-- 存储在 archive/yyyy-MM/ 目录下，每天一个新文件，超过大小则加索引 %i，并压缩为 .gz -->
            <fileNamePattern>${LOG_PATH}/archive/%d{yyyy-MM}/${APP_NAME}.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            
            <!-- 保留30天的历史日志 -->
            <maxHistory>30</maxHistory>
            
            <!-- 每个日志文件的最大大小 -->
            <maxFileSize>10MB</maxFileSize>
            
            <!-- 所有归档文件的总大小上限 -->
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>

        <encoder>
            <pattern>${DEF_LOG_FORMAT}</pattern>
        </encoder>
    </appender>

    <!-- D. 异步日志 Appender -->
    <!-- 它包装了滚动归档 Appender，以提高性能 -->
    <appender name="ASYNC_ARCHIVE" class="ch.qos.logback.classic.AsyncAppender">
        <!-- 队列满时，不阻塞主线程，直接丢弃 TRACE, DEBUG, INFO 级别的日志 -->
        <discardingThreshold>0</discardingThreshold>
        <!-- 异步队列的大小 -->
        <queueSize>256</queueSize>
        <!-- 引用需要异步处理的 Appender -->
        <appender-ref ref="ROLLING_FILE_ARCHIVE"/>
    </appender>


    <!-- ================================================================== -->
    <!--                              Loggers                               -->
    <!-- ================================================================== -->

    <!-- Root Logger: 全局日志配置 -->
    <!-- level="INFO" 表示默认记录 INFO, WARN, ERROR 级别的日志 -->
    <root level="INFO">
        <appender-ref ref="STDOUT"/>           <!-- 将日志输出到控制台 -->
        <appender-ref ref="TEMP_FILE"/>        <!-- 将所有 INFO 及以上日志输出到临时文件 -->
        <appender-ref ref="ASYNC_ARCHIVE"/>    <!-- 将 WARN 及以上日志异步输出到归档文件 -->
    </root>

</configuration>
